--US407--

SET SERVEROUTPUT ON;

DROP PROCEDURE generateMaps;
CREATE OR REPLACE PROCEDURE generateMaps
AS
    v_COUNT INTEGER;

BEGIN
FOR i IN(SELECT t.DEPARTURE_DATE, t.ARRIVAL_DATE, v.VEHICLE_ID, s.MMSI, cm.CARGO_MANIFEST_ID, cm.TYPE, l.NAME, c.CONTAINER_ID, ccm.X, ccm.Y, ccm.Z
    FROM VEHICLE v
        INNER JOIN SHIP s ON s.VEHICLE_ID = v.VEHICLE_ID
        INNER JOIN SHIP_CONTAINER sc ON sc.MMSI = s.MMSI
        INNER JOIN CONTAINER c ON c.CONTAINER_ID = sc.CONTAINER_ID
        INNER JOIN CONTAINER_CARGO_MANIFEST ccm ON ccm.CONTAINER_ID = c.CONTAINER_ID
        INNER JOIN CARGO_MANIFEST cm ON v.VEHICLE_ID = cm.VEHICLE_ID
        INNER JOIN STOPS ss ON cm.STOPS_NAME = ss.STOPS_NAME
        INNER JOIN TRIP t ON t.TRIP_ID = ss.TRIP_ID
        INNER JOIN LOCATION l ON l.TRIP_ID = t.TRIP_ID
    WHERE t.ARRIVAL_DATE < SYSDATE + INTERVAL '8' DAY
    AND t.DEPARTURE_DATE > SYSDATE
    ORDER BY t.ARRIVAL_DATE)
    

LOOP
    SELECT COUNT(*) INTO v_COUNT
    FROM CONTAINER_CARGO_MANIFEST cm
    WHERE CARGO_MANIFEST_ID = cm.CARGO_MANIFEST_ID;
    
    DBMS_OUTPUT.PUT_LINE('DEPARTURE DATE: ' ||i.DEPARTURE_DATE || ' ARRIVAL DATE: ' || i.ARRIVAL_DATE || ' VEHICLE ID: ' || i.VEHICLE_ID || ' SHIP MMSI: ' || i.MMSI || ' CARGO MANIFEST ID: ' || i.CARGO_MANIFEST_ID || ' TYPE OF MANIFEST: ' || i.TYPE || ' LOCATION: ' || i.NAME || ' CONTAINER ID: ' || i.CONTAINER_ID || ' X: ' || i.X || ' Y: ' || i.Y || ' Z: ' || i.Z);

END LOOP;
    DBMS_OUTPUT.PUT_LINE(' NUMBER OF CONTAINERS: ' || v_COUNT);
END;

EXECUTE generateMaps;


--INSERTS--
INSERT INTO VEHICLE VALUES (123);
INSERT INTO VEHICLE VALUES (234);
INSERT INTO VEHICLE VALUES(50);

INSERT INTO SHIP VALUES (238756490, 'IMO1234567', 1111111, 97,'HELLO', 10, 12.3, 70, 294, 13, 123);
INSERT INTO SHIP VALUES (192837465, 'IMO2345678', 1111112, 80,'BYE', 20, 18.3, 90, 494, 10, 234);

INSERT INTO TRUCK VALUES (50, 56789, 'MYTRUCK', 50);

INSERT INTO TRIP VALUES(1234, 123, 238756490 ,'LISBON', 'FARO', '2022-01-25', '2022-01-28');
INSERT INTO TRIP VALUES(2345, 234, 192837465 ,'LEIXOES', 'LISBON', '2022-01-26', '2022-01-27');
INSERT INTO TRIP VALUES(3456, 50, 192837465 ,'LISBON', 'MADRID', '2022-01-27', '2022-01-28');

INSERT INTO STOPS VALUES ('CASCAIS', 1234, '2022-01-27','2022-01-27');
INSERT INTO STOPS VALUES ('COIMBRA', 2345, '2022-01-27','2022-01-26');
INSERT INTO STOPS VALUES ('SEVILLA', 3456, '2022-01-28', '2022-01-27');

INSERT INTO CONTINENT VALUES('EUROPE');

INSERT INTO POSITION VALUES('55', 38.716, 9.16);
INSERT INTO POSITION VALUES('54', 38.716, 9.16);
INSERT INTO POSITION VALUES('99', 39.234, 10.28);

INSERT INTO COUNTRY VALUES('EUROPE', 'PT', 'PRT', 'PORTUGAL', 10.31, 'LISBON', 38.716, 9.16);
INSERT INTO COUNTRY VALUES('EUROPE', 'ES', 'ESP', 'SPAIN', 20.31, 'MADRID', 39.234, 10.28);

INSERT INTO LOCATION VALUES(55,'CASCAIS', 55, 'PORTUGAL', 'PORT', 1234, 20);
INSERT INTO LOCATION VALUES(54,'COIMBRA', 54, 'PORTUGAL', 'PORT', 2345, 15);
INSERT INTO LOCATION VALUES(99,'SEVILLA', 99, 'SPAIN', 'WAREHOUSE', 3456, 100);

INSERT INTO CARGO_MANIFEST VALUES (23, 5, '2022-01-25', 'LOADED', 55, 'CASCAIS', 123);
INSERT INTO CARGO_MANIFEST VALUES (24, 7, '2022-01-26', 'UNLOADED', 54, 'COIMBRA', 234);
INSERT INTO CARGO_MANIFEST VALUES (25, 8, '2022-01-27', 'UNLOADED', 99, 'SEVILLA', 50);

INSERT INTO CONTAINER VALUES (99, 124.2, 198.2, 876.4, 'REFRIG', 12);
INSERT INTO CONTAINER VALUES (100, 100.2, 100.2, 900.4, 'NOTREFRIG', 15);
INSERT INTO CONTAINER VALUES (101, 150.2, 99.2, 500.4, 'NOTREFRIG', 16);

INSERT INTO CONTAINER VALUES (11, 124.2, 198.2, 876.4, 'REFRIG', 12);
INSERT INTO CONTAINER VALUES (12, 100.2, 100.2, 900.4, 'NOTREFRIG', 15);
INSERT INTO CONTAINER VALUES (13, 150.2, 99.2, 500.4, 'NOTREFRIG', 16);

INSERT INTO SHIP_CONTAINER VALUES (99, 238756490);
INSERT INTO SHIP_CONTAINER VALUES (100, 238756490);
INSERT INTO SHIP_CONTAINER VALUES (101, 238756490);

INSERT INTO SHIP_CONTAINER VALUES (11, 192837465);
INSERT INTO SHIP_CONTAINER VALUES (12, 192837465);
INSERT INTO SHIP_CONTAINER VALUES (13, 192837465);

INSERT INTO CONTAINER_CARGO_MANIFEST VALUES (99, 23, 1,1,1, 'FARO');
INSERT INTO CONTAINER_CARGO_MANIFEST VALUES (100, 23, 2,1,1, 'FARO');
INSERT INTO CONTAINER_CARGO_MANIFEST VALUES (101, 23, 3,1,1, 'FARO');

INSERT INTO CONTAINER_CARGO_MANIFEST VALUES (11, 24, 1,1,1, 'LISBON');
INSERT INTO CONTAINER_CARGO_MANIFEST VALUES (12, 24, 2,1,1, 'LISBON');
INSERT INTO CONTAINER_CARGO_MANIFEST VALUES (13, 24, 3,1,1, 'LISBON');

INSERT INTO STAFF VALUES(9876,'JOAO', 23, 55, 'CASCAIS');

INSERT INTO STAFF_SHIP VALUES(238756490,9876);
INSERT INTO STAFF_SHIP VALUES(192837465,9876);


	
/*O mapa de loading/unloading é uma lista, ordenada por ordem cronológica de todos as cargas e descargas de navios e camiões
previstas para a próxima semana, com os seguintes elementos: data de load/unload, navio/truck, número de contentores a
carregar/descarregar e detalhes da cada contentor a carregar/descarregar em cada load/unload, em particular, a posição no navio.*/